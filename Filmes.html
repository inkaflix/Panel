<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel Admin Blogger con TMDb - Series y Pel√≠culas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: sans-serif; background: #121212; color: #eee; padding: 20px; max-width: 900px; margin: auto; }
    h2 { text-align: center; margin-bottom: 20px; }
    input, textarea, button, select {
      width: 100%; margin-top: 10px; padding: 10px; font-size: 1rem; border-radius: 5px; border: none;
      box-sizing: border-box;
      background-color: #222; color: #eee;
    }
    button {
      background-color: #1db954; color: white; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease;
      border: none;
      margin-top: 10px;
    }
    button:hover { background-color: #14833b; }
    select { background-color: #222; color: white; }
    #searchResults {
      border: 1px solid #444; max-height: 200px; overflow-y: auto; margin-top: 0; padding: 0; list-style: none;
      background: #1e1e1e; border-radius: 5px;
      position: absolute; width: 100%; z-index: 1000;
    }
    #searchResults li {
      padding: 10px; cursor: pointer; border-bottom: 1px solid #333;
    }
    #searchResults li:hover {
      background-color: #333;
    }
    #movieGrid {
      margin-top: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(140px,1fr));
      gap: 10px;
      position: relative;
    }
    .movie-card {
      background: #222; border-radius: 8px; overflow: hidden; cursor: pointer;
      box-shadow: 0 0 8px rgba(0,0,0,0.7);
      transition: transform 0.2s ease;
    }
    .movie-card:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px #1db954;
    }
    .movie-card img {
      width: 100%; height: auto; display: block;
    }
    .title {
      padding: 5px 8px; font-weight: bold; font-size: 0.9rem; white-space: nowrap;
      overflow: hidden; text-overflow: ellipsis; color: #1db954;
    }
    .release-date {
      padding: 0 8px 8px 8px; font-size: 0.75rem; color: #aaa;
    }
    #loadingSpinner {
      display: none; text-align: center; margin-top: 20px;
      color: #1db954;
    }
    /* Dialogo modal */
    #movieDialog {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #222; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.9);
      padding: 20px; max-width: 600px; max-height: 80vh; overflow-y: auto; z-index: 2000;
      color: #eee;
      display: none;
      white-space: pre-wrap;
    }
    #closeDialog {
      background: #e74c3c; color: white; padding: 5px 10px; border: none; border-radius: 5px;
      cursor: pointer; float: right; font-weight: bold; margin-top: -10px; margin-bottom: 10px;
    }
    #blurOverlay {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(3px);
      z-index: 1500;
      display: none;
    }
    .hidden { display: none !important; }
    .form-group { position: relative; margin-bottom: 20px; }
  </style>
</head>
<body>
  <h2>üìã Panel Admin Blogger con TMDb - Series y Pel√≠culas</h2>

  <button id="authBtn">üîê Iniciar sesi√≥n con Google</button>

  <div id="formSection" class="hidden">

    <div class="form-group">
      <input type="text" id="tmdbSearch" placeholder="Buscar serie o pel√≠cula en TMDb..." autocomplete="off" />
      <ul id="searchResults" class="hidden"></ul>
    </div>

    <div class="form-group">
      <select id="genreFilter">
        <option value="">-- Filtrar por g√©nero --</option>
      </select>
    </div>

    <div class="form-group">
      <select id="yearFilter">
        <option value="">-- Filtrar por a√±o --</option>
      </select>
    </div>

    <div style="display:flex; gap:10px; flex-wrap: wrap;">
      <button id="discoverSeriesButton" style="flex:1;">Descubrir series populares</button>
      <button id="discoverMoviesButton" style="flex:1;">Descubrir pel√≠culas populares</button>
    </div>
    <button id="searchButton" style="margin-top:10px;">Buscar filtrado</button>

    <div id="movieGrid"></div>

    <div id="loadingSpinner">Cargando...</div>

    <hr>

    <input type="text" id="postTitle" placeholder="T√≠tulo de la entrada" />
    <textarea id="postContent" rows="12" placeholder="Contenido HTML"></textarea>
    <input type="text" id="postLabels" placeholder="Etiquetas separadas por comas" />

    <button id="publishButton">üöÄ Publicar Entrada</button>

    <p id="status"></p>
  </div>

  <!-- Di√°logo modal para mostrar plantilla copiada o info -->
  <div id="movieDialog">
    <button id="closeDialog">Cerrar ‚úñ</button>
    <pre id="dialogContent"></pre>
  </div>
  <div id="blurOverlay"></div>

<script>
  // Config Google API y TMDb
  const CLIENT_ID = '155693540835-c5528m80r913cahna97nmg7t834pgaub.apps.googleusercontent.com';
  const API_KEY = 'AIzaSyBvtH_J_Xs6TnD4VpQxdlgcOjXrYZtVyLk';
  const BLOG_ID = '3812927193244872888';
  const SCOPES = 'https://www.googleapis.com/auth/blogger';

  const TMDB_API_KEY = 'dc340e81a2bdef1a7bcb0b31358487fd';
  const imageBase = "https://image.tmdb.org/t/p/w500";
  const backdropBase = "https://image.tmdb.org/t/p/w1280";

  // Google API variables
  let tokenClient;
  let gapiInited = false;

  // UI Elements
  const authBtn = document.getElementById('authBtn');
  const formSection = document.getElementById('formSection');
  const tmdbSearch = document.getElementById('tmdbSearch');
  const searchResults = document.getElementById('searchResults');
  const genreSelect = document.getElementById('genreFilter');
  const yearSelect = document.getElementById('yearFilter');
  const discoverSeriesBtn = document.getElementById('discoverSeriesButton');
  const discoverMoviesBtn = document.getElementById('discoverMoviesButton');
  const searchBtn = document.getElementById('searchButton');
  const movieGrid = document.getElementById('movieGrid');
  const spinner = document.getElementById('loadingSpinner');
  const postTitle = document.getElementById('postTitle');
  const postContent = document.getElementById('postContent');
  const postLabels = document.getElementById('postLabels');
  const publishButton = document.getElementById('publishButton');
  const status = document.getElementById('status');

  const movieDialog = document.getElementById('movieDialog');
  const dialogContent = document.getElementById('dialogContent');
  const closeDialog = document.getElementById('closeDialog');
  const blurOverlay = document.getElementById('blurOverlay');

  // Estado
  let currentPage = 1;
  let totalPages = 1;
  let currentMode = "discoverSeries"; // discoverSeries, discoverMovies, searchSeries, searchMovies
  let currentQuery = "";
  let currentGenre = "";
  let currentYear = "";
  let isLoading = false;

  // Google API init
  function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
  }

  async function initializeGapiClient() {
    await gapi.client.init({ apiKey: API_KEY });
    gapiInited = true;
  }

  function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: (tokenResponse) => {
        gapi.client.setToken(tokenResponse);
        formSection.classList.remove('hidden');
        authBtn.style.display = 'none';
      },
    });
  }

  function handleAuth() {
    tokenClient.requestAccessToken();
  }

  // Mostrar/Ocultar spinner
  function showSpinner() { spinner.style.display = "block"; }
  function hideSpinner() { spinner.style.display = "none"; }

  // Formatear fecha
  function formatDate(dateStr) {
    if (!dateStr) return "";
    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const date = new Date(dateStr);
    const month = months[date.getUTCMonth()];
    const day = date.getUTCDate();
    const year = date.getUTCFullYear();
    return `${month} ${day}, ${year}`;
  }

  // Cargar g√©neros TMDb para series y pel√≠culas
  function loadGenres() {
    fetch(`https://api.themoviedb.org/3/genre/tv/list?api_key=${TMDB_API_KEY}&language=es-ES`)
      .then(res => res.json())
      .then(data => {
        data.genres.forEach(genre => {
          const option = document.createElement("option");
          option.value = genre.id;
          option.textContent = genre.name;
          genreSelect.appendChild(option);
        });
      })
      .catch(() => {
        const defaultGenres = [
          {id: 10759, name: "Acci√≥n y aventura"},
          {id: 35, name: "Comedia"},
          {id: 18, name: "Drama"},
        ];
        defaultGenres.forEach(genre => {
          const option = document.createElement("option");
          option.value = genre.id;
          option.textContent = genre.name;
          genreSelect.appendChild(option);
        });
      });
  }

  // Cargar a√±os en select
  function loadYears() {
    for (let y = 2025; y >= 1950; y--) {
      const option = document.createElement("option");
      option.value = y;
      option.textContent = y;
      yearSelect.appendChild(option);
    }
  }

  // --- Funciones para Series ---

  function fetchSeries(url, append = false) {
    isLoading = true;
    showSpinner();
    fetch(url)
      .then(res => res.json())
      .then(data => {
        displaySeries(data.results, append);
        totalPages = data.total_pages;
        isLoading = false;
        hideSpinner();
      })
      .catch(() => {
        isLoading = false;
        hideSpinner();
        if (!append) movieGrid.innerHTML = "<p style='color:#ccc'>Error cargando series.</p>";
      });
  }

  function displaySeries(seriesList, append = false) {
    if (!append) movieGrid.innerHTML = "";
    if (!seriesList || seriesList.length === 0) {
      if (!append) movieGrid.innerHTML = "<p style='color:#ccc'>No se encontraron series.</p>";
      return;
    }
    seriesList.forEach(serie => {
      const card = document.createElement("div");
      card.className = "movie-card";
      const formattedDate = formatDate(serie.first_air_date);
      card.innerHTML = `
        <img src="${serie.poster_path ? imageBase + serie.poster_path : 'https://via.placeholder.com/500x750?text=No+Image'}" alt="${serie.name}" />
        <div class="title">${serie.name}</div>
        <div class="release-date">${formattedDate}</div>
      `;
      card.addEventListener("click", () => showSeriesDetails(serie.id));
      movieGrid.appendChild(card);
    });
  }

  function showSeriesDetails(seriesId) {
    const url = `https://api.themoviedb.org/3/tv/${seriesId}?api_key=${TMDB_API_KEY}&language=es-ES&append_to_response=videos`;
    fetch(url)
      .then(res => res.json())
      .then(series => {
        const year = series.first_air_date ? series.first_air_date.split("-")[0] : "";
        const genres = series.genres?.map(g => g.name) || [];
        const trailer = series.videos?.results.find(v => v.site === "YouTube" && v.type === "Trailer");
        const trailerId = trailer ? trailer.key : "";
        const duration = series.episode_run_time?.[0] || 'N/A';

        const htmlOutput = `
<!-- Configuration episode list -->

<!-- Name: ${series.name} -->

<!-- Genres: ${genres.join(",")},${year},Series,2024 -->

<!--  -->
<div data-post-type="serie" hidden>
  <img src="${imageBase + series.poster_path}" alt="${series.name}"/>
  <p id="tmdb-synopsis">${series.overview}</p>
</div>
<a name='more'></a>
<!-- This generator was created by Plantillas CJ y Plantillas JMA -->
<div
  data-youtube-id="${trailerId}"
  data-backdrop="${backdropBase + series.backdrop_path}"
  data-imdb="${series.vote_average}"
  data-year="${year}"
  data-duration="${duration} min">
</div>
<!--  -->
<div class="headline is-small mb-4">
  <h2 class="headline__title">Information</h2>
</div>
<ul class="post-details mb-4">
  <li><span>Title</span>${series.name}</li>
  <li><span>Original titles</span>${series.original_name}</li>
  <li data-duration="${duration} min"><span>Duration</span>${duration} min</li>
  <li data-year="${year}"><span>Year</span>${year}</li>
  <li data-episodes-count="${series.number_of_episodes}"><span>Episodes</span>${series.number_of_episodes}</li>
  <li data-seasons-count="${series.number_of_seasons}"><span>Seasons</span>${series.number_of_seasons}</li>
  <li><span>Release date</span>${series.first_air_date}</li>
  <li><span>Genres</span>${genres.join(", ")}</li>
</ul>
<!-- This generator was created by Plantillas CJ y Plantillas JMA -->
`;

        // Rellenar formulario
        postTitle.value = series.name;
        postContent.value = htmlOutput;
        postLabels.value = genres.join(", ");

        // Mostrar di√°logo modal con el contenido para confirmar (opcional)
        dialogContent.textContent = htmlOutput;
        movieDialog.style.display = "block";
        blurOverlay.style.display = "block";
      })
      .catch(() => {
        alert("Error cargando detalles de la serie.");
      });
  }

  // --- Funciones para Pel√≠culas ---

  function fetchMovies(url, append = false) {
    isLoading = true;
    showSpinner();
    fetch(url)
      .then(res => res.json())
      .then(data => {
        displayMovies(data.results, append);
        totalPages = data.total_pages;
        isLoading = false;
        hideSpinner();
      })
      .catch(() => {
        isLoading = false;
        hideSpinner();
        if (!append) movieGrid.innerHTML = "<p style='color:#ccc'>Error cargando pel√≠culas.</p>";
      });
  }

  function displayMovies(movieList, append = false) {
    if (!append) movieGrid.innerHTML = "";
    if (!movieList || movieList.length === 0) {
      if (!append) movieGrid.innerHTML = "<p style='color:#ccc'>No se encontraron pel√≠culas.</p>";
      return;
    }
    movieList.forEach(movie => {
      const card = document.createElement("div");
      card.className = "movie-card";
      const formattedDate = formatDate(movie.release_date);
      card.innerHTML = `
        <img src="${movie.poster_path ? imageBase + movie.poster_path : 'https://via.placeholder.com/500x750?text=No+Image'}" alt="${movie.title}" />
        <div class="title">${movie.title}</div>
        <div class="release-date">${formattedDate}</div>
      `;
      card.addEventListener("click", () => showMovieDetails(movie.id));
      movieGrid.appendChild(card);
    });
  }

  function showMovieDetails(movieId) {
    const url = `https://api.themoviedb.org/3/movie/${movieId}?api_key=${TMDB_API_KEY}&language=es-ES&append_to_response=videos`;
    fetch(url)
      .then(res => res.json())
      .then(movie => {
        const year = movie.release_date ? movie.release_date.split("-")[0] : "";
        const genres = movie.genres?.map(g => g.name) || [];
        const trailer = movie.videos?.results.find(v => v.site === "YouTube" && v.type === "Trailer");
        const trailerId = trailer ? trailer.key : "";
        const duration = movie.runtime || 'N/A';

        const htmlOutput = `
<!-- Configuration episode list -->

<!-- Name: ${movie.title} -->

<!-- Genres: ${genres.join(",")},${year},Movie,2024 -->

<!--  -->
<div data-post-type="movie" hidden>
  <img src="${imageBase + movie.poster_path}" alt="${movie.title}"/>
  <p id="tmdb-synopsis">${movie.overview}</p>
</div>
<a name='more'></a>
<!-- This generator was created by Plantillas CJ y Plantillas JMA -->
<div
  data-youtube-id="${trailerId}"
  data-backdrop="${backdropBase + movie.backdrop_path}"
  data-imdb="${movie.vote_average}"
  data-year="${year}"
  data-duration="${duration} min">
</div>
<!--  -->
<div class="headline is-small mb-4">
  <h2 class="headline__title">Information</h2>
</div>
<ul class="post-details mb-4">
  <li><span>Title</span>${movie.title}</li>
  <li><span>Original titles</span>${movie.original_title}</li>
  <li data-duration="${duration} min"><span>Duration</span>${duration} min</li>
  <li data-year="${year}"><span>Year</span>${year}</li>
  <li><span>Release date</span>${movie.release_date}</li>
  <li><span>Genres</span>${genres.join(", ")}</li>
</ul>
<!-- This generator was created by Plantillas CJ y Plantillas JMA -->
`;

        // Rellenar formulario
        postTitle.value = movie.title;
        postContent.value = htmlOutput;
        postLabels.value = genres.join(", ");

        // Mostrar di√°logo modal con el contenido para confirmar (opcional)
        dialogContent.textContent = htmlOutput;
        movieDialog.style.display = "block";
        blurOverlay.style.display = "block";
      })
      .catch(() => {
        alert("Error cargando detalles de la pel√≠cula.");
      });
  }

  // Scroll infinito
  window.addEventListener("scroll", () => {
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200 && !isLoading && currentPage < totalPages) {
      currentPage++;
      let url;
      if (currentMode === "discoverSeries") {
        url = `https://api.themoviedb.org/3/discover/tv?api_key=${TMDB_API_KEY}&language=es-ES&sort_by=popularity.desc&page=${currentPage}`;
        if (currentGenre) url += `&with_genres=${currentGenre}`;
        if (currentYear) url += `&first_air_date_year=${currentYear}`;
        fetchSeries(url, true);
      } else if (currentMode === "discoverMovies") {
        url = `https://api.themoviedb.org/3/discover/movie?api_key=${TMDB_API_KEY}&language=es-ES&sort_by=popularity.desc&page=${currentPage}`;
        if (currentGenre) url += `&with_genres=${currentGenre}`;
        if (currentYear) url += `&primary_release_year=${currentYear}`;
        fetchMovies(url, true);
      } else if (currentMode === "searchSeries") {
        url = `https://api.themoviedb.org/3/search/tv?api_key=${TMDB_API_KEY}&language=es-ES&query=${encodeURIComponent(currentQuery)}&page=${currentPage}`;
        fetchSeries(url, true);
      } else if (currentMode === "searchMovies") {
        url = `https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&language=es-ES&query=${encodeURIComponent(currentQuery)}&page=${currentPage}`;
        fetchMovies(url, true);
      }
    }
  });

  // Eventos botones
  discoverSeriesBtn.addEventListener("click", () => {
    currentPage = 1;
    currentMode = "discoverSeries";
    currentGenre = genreSelect.value;
    currentYear = yearSelect.value;
    currentQuery = "";

    let url = `https://api.themoviedb.org/3/discover/tv?api_key=${TMDB_API_KEY}&language=es-ES&sort_by=popularity.desc&page=${currentPage}`;
    if (currentGenre) url += `&with_genres=${currentGenre}`;
    if (currentYear) url += `&first_air_date_year=${currentYear}`;

    fetchSeries(url);
  });

  discoverMoviesBtn.addEventListener("click", () => {
    currentPage = 1;
    currentMode = "discoverMovies";
    currentGenre = genreSelect.value;
    currentYear = yearSelect.value;
    currentQuery = "";

    let url = `https://api.themoviedb.org/3/discover/movie?api_key=${TMDB_API_KEY}&language=es-ES&sort_by=popularity.desc&page=${currentPage}`;
    if (currentGenre) url += `&with_genres=${currentGenre}`;
    if (currentYear) url += `&primary_release_year=${currentYear}`;

    fetchMovies(url);
  });

  searchBtn.addEventListener("click", () => {
    currentPage = 1;
    currentQuery = tmdbSearch.value.trim();
    currentGenre = "";
    currentYear = "";

    if (!currentQuery) {
      movieGrid.innerHTML = "<p style='color:#ccc'>Escribe un t√©rmino para buscar.</p>";
      return;
    }

    // Decide si buscar serie o pel√≠cula seg√∫n prefijo (ejemplo: "movie: Batman" o "serie: Friends")
    let url;
    if (currentQuery.toLowerCase().startsWith("movie:")) {
      currentMode = "searchMovies";
      currentQuery = currentQuery.substr(6).trim();
      url = `https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&language=es-ES&query=${encodeURIComponent(currentQuery)}&page=${currentPage}`;
      fetchMovies(url);
    } else {
      currentMode = "searchSeries";
      if (currentQuery.toLowerCase().startsWith("serie:")) {
        currentQuery = currentQuery.substr(6).trim();
      }
      url = `https://api.themoviedb.org/3/search/tv?api_key=${TMDB_API_KEY}&language=es-ES&query=${encodeURIComponent(currentQuery)}&page=${currentPage}`;
      fetchSeries(url);
    }
  });

  // Autocompletado en b√∫squeda
  tmdbSearch.addEventListener("input", () => {
    const query = tmdbSearch.value.trim();
    if (query.length < 3) {
      searchResults.classList.add("hidden");
      searchResults.innerHTML = "";
      return;
    }
    // Buscar tanto series como pel√≠culas, mostrar m√°ximo 7 resultados de series
    fetch(`https://api.themoviedb.org/3/search/tv?api_key=${TMDB_API_KEY}&language=es-ES&query=${encodeURIComponent(query)}&page=1`)
      .then(res => res.json())
      .then(data => {
        searchResults.innerHTML = "";
        if (!data.results || data.results.length === 0) {
          searchResults.classList.add("hidden");
          return;
        }
        data.results.slice(0, 7).forEach(serie => {
          const li = document.createElement("li");
          li.textContent = "Serie: " + serie.name;
          li.title = serie.name;
          li.addEventListener("click", () => {
            searchResults.classList.add("hidden");
            tmdbSearch.value = "serie: " + serie.name;
            showSeriesDetails(serie.id);
          });
          searchResults.appendChild(li);
        });
        searchResults.classList.remove("hidden");
      })
      .catch(() => {
        searchResults.classList.add("hidden");
        searchResults.innerHTML = "";
      });
  });

  // Ocultar autocompletado al clicar fuera
  document.addEventListener("click", (e) => {
    if (!tmdbSearch.contains(e.target) && !searchResults.contains(e.target)) {
      searchResults.classList.add("hidden");
    }
  });

  // Publicar en Blogger
  async function publishPost() {
    const title = postTitle.value.trim();
    const content = postContent.value.trim();
    const labels = postLabels.value.split(',').map(e => e.trim()).filter(e => e);

    if (!title || !content) {
      status.innerText = "‚ùå T√≠tulo y contenido son obligatorios.";
      return;
    }

    const post = {
      kind: "blogger#post",
      blog: { id: BLOG_ID },
      title: title,
      content: content,
      labels: labels
    };

    try {
      status.innerText = "‚è≥ Publicando...";
      const response = await gapi.client.request({
        path: `https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts/`,
        method: 'POST',
        body: post
      });
      status.innerHTML = `‚úÖ Publicado: <a href="${response.result.url}" target="_blank">${response.result.url}</a>`;
    } catch (err) {
      status.innerText = `‚ùå Error: ${err.message}`;
    }
  }

  // Eventos botones
  publishButton.addEventListener("click", publishPost);

  // Cerrar di√°logo modal
  closeDialog.addEventListener("click", () => {
    movieDialog.style.display = "none";
    blurOverlay.style.display = "none";
  });
  blurOverlay.addEventListener("click", () => {
    movieDialog.style.display = "none";
    blurOverlay.style.display = "none";
  });

  // Autenticaci√≥n Google
  authBtn.addEventListener("click", handleAuth);

  // Cargar g√©neros y a√±os al inicio
  loadGenres();
  loadYears();

  // Carga Google API
  window.onload = () => {
    if (window.gapi) gapiLoaded();
    if (window.google) gisLoaded();
  };
</script>

<script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

</body>
</html>
