<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel Admin Blogger con TMDb - Dise√±o Mejorado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    /* Reset b√°sico */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #f0f0f0;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .container {
      background: #1e2a38cc;
      backdrop-filter: saturate(180%) blur(20px);
      border-radius: 15px;
      padding: 25px 30px;
      max-width: 900px;
      width: 100%;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    h2 {
      text-align: center;
      font-weight: 700;
      font-size: 2rem;
      color: #34d399;
      margin-bottom: 10px;
      user-select: none;
      text-shadow: 0 0 8px #10b981aa;
    }

    button {
      background: #34d399;
      border: none;
      padding: 12px 20px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1rem;
      color: #07372b;
      cursor: pointer;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
      box-shadow: 0 6px 12px rgba(52,211,153,0.4);
    }
    button:hover, button:focus {
      background: #22c55e;
      box-shadow: 0 8px 15px rgba(34,197,94,0.6);
      outline: none;
    }
    button:disabled {
      background: #4ade80aa;
      cursor: not-allowed;
      box-shadow: none;
    }

    input[type=text], textarea, select {
      width: 100%;
      padding: 14px 18px;
      border-radius: 12px;
      border: none;
      background: #2a3948cc;
      color: #cbd5e1;
      font-size: 1rem;
      font-weight: 500;
      box-shadow: inset 0 0 8px #00000077;
      transition: background-color 0.3s ease;
      resize: vertical;
      user-select: text;
    }
    input[type=text]:focus, textarea:focus, select:focus {
      background: #2a3948ee;
      outline: none;
      box-shadow: 0 0 12px #34d399aa;
      color: #e6fffa;
    }

    /* Layout grilla series */
    #movieGrid {
      margin-top: 15px;
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(140px,1fr));
      gap: 15px;
      user-select: none;
    }

    .movie-card {
      background: #2a3948cc;
      border-radius: 14px;
      overflow: hidden;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      display: flex;
      flex-direction: column;
      user-select: none;
    }
    .movie-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 8px 20px #22c55eaa;
    }
    .movie-card img {
      width: 100%;
      height: 210px;
      object-fit: cover;
      border-bottom: 3px solid #22c55e;
      pointer-events: none;
    }
    .title {
      font-weight: 700;
      font-size: 1rem;
      padding: 8px 10px 3px 10px;
      color: #22c55e;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      user-select: text;
    }
    .release-date {
      font-size: 0.75rem;
      color: #94a3b8;
      padding: 0 10px 10px 10px;
      font-style: italic;
      user-select: text;
    }

    /* Spinner */
    #loadingSpinner {
      color: #22c55e;
      font-weight: 600;
      text-align: center;
      user-select: none;
    }

    /* Autocomplete lista */
    #searchResults {
      position: absolute;
      top: 44px;
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
      background: #1f2937cc;
      border-radius: 10px;
      box-shadow: 0 0 12px #22c55eaa;
      list-style: none;
      padding: 0;
      margin: 0;
      z-index: 1100;
      user-select: none;
    }
    #searchResults li {
      padding: 12px 18px;
      cursor: pointer;
      color: #d1d5db;
      font-weight: 500;
      transition: background-color 0.2s ease;
      user-select: text;
    }
    #searchResults li:hover {
      background: #22c55e88;
      color: #072f17;
    }

    /* Modal di√°logo */
    #movieDialog {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #0f172a;
      border-radius: 20px;
      box-shadow: 0 10px 30px #22c55eaa;
      padding: 20px 25px;
      width: 90%;
      max-width: 700px;
      max-height: 80vh;
      overflow-y: auto;
      color: #d1d5db;
      z-index: 1500;
      display: none;
      user-select: text;
    }
    #movieDialog pre {
      white-space: pre-wrap;
      word-break: break-word;
      font-family: 'Fira Mono', monospace;
      background: #1e293b;
      padding: 15px;
      border-radius: 14px;
      box-shadow: inset 0 0 10px #000000cc;
      font-size: 0.9rem;
      user-select: text;
    }
    #closeDialog {
      background: #dc2626;
      border: none;
      color: white;
      font-weight: 700;
      padding: 8px 15px;
      border-radius: 14px;
      cursor: pointer;
      float: right;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    #closeDialog:hover, #closeDialog:focus {
      background: #b91c1c;
      outline: none;
    }

    #blurOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(4px);
      z-index: 1400;
      display: none;
      user-select: none;
    }

    /* Formularios agrupados */
    .form-group {
      position: relative;
      width: 100%;
    }
    /* Para que el buscador tenga margen abajo y autocomplete no choque */
    .form-group.search {
      margin-bottom: 0;
    }

    /* Responsividad */
    @media (max-width: 600px) {
      .movie-card img {
        height: 170px;
      }
      button {
        font-size: 0.9rem;
      }
    }

  </style>
</head>
<body>
  <div class="container">

    <h2>üìã Panel Admin Blogger con TMDb</h2>

    <button id="authBtn">üîê Iniciar sesi√≥n con Google</button>

    <div id="formSection" class="hidden">

      <div class="form-group search" style="margin-bottom: 5px;">
        <input type="text" id="tmdbSearch" placeholder="Buscar serie en TMDb..." autocomplete="off" />
        <ul id="searchResults" class="hidden"></ul>
      </div>

      <div class="form-group">
        <select id="genreFilter" aria-label="Filtrar por g√©nero">
          <option value="">-- Filtrar por g√©nero --</option>
        </select>
      </div>

      <div class="form-group">
        <select id="yearFilter" aria-label="Filtrar por a√±o">
          <option value="">-- Filtrar por a√±o --</option>
        </select>
      </div>

      <button id="discoverButton" aria-label="Descubrir series populares">Descubrir series populares</button>
      <button id="searchButton" aria-label="Buscar series filtradas">Buscar series filtradas</button>

      <div id="movieGrid" aria-live="polite" aria-atomic="true" role="list"></div>

      <div id="loadingSpinner" aria-hidden="true">Cargando...</div>

      <hr style="border-color: #334155; margin: 25px 0;">

      <input type="text" id="postTitle" placeholder="T√≠tulo de la entrada" aria-label="T√≠tulo de la entrada" />
      <textarea id="postContent" rows="12" placeholder="Contenido HTML" aria-label="Contenido HTML"></textarea>
      <input type="text" id="postLabels" placeholder="Etiquetas separadas por comas" aria-label="Etiquetas separadas por comas" />

      <button id="publishButton">üöÄ Publicar Entrada</button>

      <p id="status" role="alert" aria-live="polite"></p>

    </div>

  </div>

  <!-- Di√°logo modal para mostrar plantilla copiada o info -->
  <div id="movieDialog" role="dialog" aria-modal="true" aria-labelledby="dialogTitle" aria-describedby="dialogContent">
    <button id="closeDialog" aria-label="Cerrar di√°logo">Cerrar ‚úñ</button>
    <pre id="dialogContent"></pre>
  </div>
  <div id="blurOverlay" tabindex="-1"></div>

<script>
  // -- C√≥digo JS igual que antes, pero para que lo tengas completo:

  const CLIENT_ID = '155693540835-c5528m80r913cahna97nmg7t834pgaub.apps.googleusercontent.com';
const API_KEY = 'AIzaSyBvtH_J_Xs6TnD4VpQxdlgcOjXrYZtVyLk';
const BLOG_ID = '3812927193244872888';
const SCOPES = 'https://www.googleapis.com/auth/blogger';
const TMDB_API_KEY = "dc340e81a2bdef1a7bcb0b31358487fd";
const imageBase = "https://image.tmdb.org/t/p/w500";
const backdropBase = "https://image.tmdb.org/t/p/w1280";

let tokenClient;
let gapiInited = false;

const authBtn = document.getElementById('authBtn');
const formSection = document.getElementById('formSection');
const publishButton = document.getElementById('publishButton');
const status = document.getElementById('status');
const tmdbSearch = document.getElementById('tmdbSearch');
const searchResults = document.getElementById('searchResults');
const genreSelect = document.getElementById('genreFilter');
const yearSelect = document.getElementById('yearFilter');
const discoverBtn = document.getElementById('discoverButton');
const searchBtn = document.getElementById('searchButton');
const movieGrid = document.getElementById('movieGrid');
const loadingSpinner = document.getElementById('loadingSpinner');
const movieDialog = document.getElementById('movieDialog');
const dialogContent = document.getElementById('dialogContent');
const closeDialog = document.getElementById('closeDialog');
const blurOverlay = document.getElementById('blurOverlay');

let currentPage = 1;
let totalPages = 1;
let currentMode = "discover";
let currentQuery = "";
let currentGenre = "";
let currentYear = "";
let isLoading = false;

function gapiLoaded() {
  gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
  await gapi.client.init({ apiKey: API_KEY });
  gapiInited = true;
}

function gisLoaded() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: (tokenResponse) => {
      if (tokenResponse.error) {
        status.textContent = 'Error de autenticaci√≥n: ' + tokenResponse.error;
        return;
      }
      gapi.client.setToken(tokenResponse);
      authBtn.style.display = 'none';
      formSection.classList.remove('hidden');
      status.textContent = '‚úÖ Autenticado, listo para publicar.';
    },
  });
}

function handleAuth() {
  tokenClient.requestAccessToken();
}

function showSpinner() {
  loadingSpinner.style.display = "block";
}

function hideSpinner() {
  loadingSpinner.style.display = "none";
}

function formatDate(dateStr) {
  if (!dateStr) return "";
  const months = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
  const date = new Date(dateStr);
  const month = months[date.getUTCMonth()];
  const day = date.getUTCDate();
  const year = date.getUTCFullYear();
  return `${day} ${month} ${year}`;
}

function fetchSeries(url, append = false) {
  isLoading = true;
  showSpinner();
  fetch(url)
    .then(res => res.json())
    .then(data => {
      displaySeries(data.results, append);
      totalPages = data.total_pages;
      isLoading = false;
      hideSpinner();
    })
    .catch(() => {
      isLoading = false;
      hideSpinner();
      if (!append) movieGrid.innerHTML = "<p style='color:#ccc'>Error cargando series.</p>";
    });
}

function displaySeries(seriesList, append = false) {
  if (!append) movieGrid.innerHTML = "";
  if (!seriesList || seriesList.length === 0) {
    if (!append) movieGrid.innerHTML = "<p style='color:#ccc'>No se encontraron series.</p>";
    return;
  }
  seriesList.forEach(serie => {
    const card = document.createElement("div");
    card.className = "movie-card";
    const formattedDate = formatDate(serie.first_air_date);
    card.innerHTML = `
      <img src="${serie.poster_path ? imageBase + serie.poster_path : 'https://via.placeholder.com/500x750?text=No+Image'}" alt="${serie.name}" />
      <div class="title">${serie.name}</div>
      <div class="release-date">${formattedDate}</div>
    `;
    card.addEventListener("click", () => showSeriesDetails(serie.id));
    movieGrid.appendChild(card);
  });
}

function showSeriesDetails(seriesId) {
  const url = `https://api.themoviedb.org/3/tv/${seriesId}?api_key=${TMDB_API_KEY}&language=es-ES&append_to_response=videos`;
  fetch(url)
    .then(res => res.json())
    .then(series => {
      const year = series.first_air_date ? series.first_air_date.split("-")[0] : "";
      const genres = series.genres?.map(g => g.name).join(", ") || "";
      const trailer = series.videos?.results.find(v => v.site === "YouTube" && v.type === "Trailer");
      const trailerId = trailer ? trailer.key : "";
      const duration = series.episode_run_time?.[0] || 'N/A';

      const htmlOutput = `<!-- Configuraci√≥n lista de episodios -->
<!-- Nombre: ${series.name} -->
<!-- G√©neros: ${genres},${year},Series,2024 -->
<div data-post-type="serie" hidden>
  <img src="${imageBase + series.poster_path}"/>
  <p id="tmdb-synopsis">${series.overview}</p>
</div>
<a name='more'></a>
<!-- Plantilla generada por Plantillas CJ y Plantillas JMA -->
<div
  data-youtube-id="${trailerId}"
  data-backdrop="${backdropBase + series.backdrop_path}"
  data-imdb="${series.vote_average}"
  data-year="${year}"
  data-duration="${duration} min">
</div>
<div class="headline is-small mb-4">
  <h2 class="headline__title">Informaci√≥n</h2>
</div>
<ul class="post-details mb-4">
  <li><span>T√≠tulo</span>${series.name}</li>
  <li><span>T√≠tulos originales</span>${series.original_name}</li>
  <li><span>Duraci√≥n</span>${duration} min</li>
  <li><span>A√±o</span>${year}</li>
  <li><span>Episodios</span>${series.number_of_episodes}</li>
  <li><span>Temporadas</span>${series.number_of_seasons}</li>
  <li><span>Fecha de estreno</span>${series.first_air_date}</li>
  <li><span>G√©neros</span>${genres}</li>
</ul>`;

      dialogContent.textContent = htmlOutput;
      movieDialog.style.display = "block";
      blurOverlay.style.display = "block";

      // Copiar al portapapeles
      navigator.clipboard.writeText(htmlOutput).then(() => {
        status.textContent = "Plantilla copiada al portapapeles ‚úîÔ∏è";
      }).catch(() => {
        status.textContent = "Error al copiar plantilla.";
      });
    })
    .catch(() => {
      alert("Error cargando detalles de la serie.");
    });
}

closeDialog.addEventListener("click", () => {
  movieDialog.style.display = "none";
  blurOverlay.style.display = "none";
});
blurOverlay.addEventListener("click", () => {
  movieDialog.style.display = "none";
  blurOverlay.style.display = "none";
});

discoverBtn.addEventListener("click", () => {
  currentPage = 1;
  currentMode = "discover";
  currentGenre = genreSelect.value;
  currentYear = yearSelect.value;
  currentQuery = "";

  let url = `https://api.themoviedb.org/3/discover/tv?api_key=${TMDB_API_KEY}&language=es-ES&sort_by=popularity.desc&page=${currentPage}`;
  if (currentGenre) url += `&with_genres=${currentGenre}`;
  if (currentYear) url += `&first_air_date_year=${currentYear}`;
  fetchSeries(url);
});

searchBtn.addEventListener("click", () => {
  currentPage = 1;
  currentMode = "search";
  currentQuery = tmdbSearch.value.trim();
  currentGenre = "";
  currentYear = "";

  if (!currentQuery) {
    movieGrid.innerHTML = "<p style='color:#ccc'>Escribe un t√©rmino para buscar.</p>";
    return;
  }

  const url = `https://api.themoviedb.org/3/search/tv?api_key=${TMDB_API_KEY}&language=es-ES&query=${encodeURIComponent(currentQuery)}&page=${currentPage}`;
  fetchSeries(url);
});

// Autocompletado b√∫squeda TMDb
tmdbSearch.addEventListener("input", () => {
  const query = tmdbSearch.value.trim();
  if (query.length < 3) {
    searchResults.classList.add("hidden");
    searchResults.innerHTML = "";
    return;
  }
  fetch(`https://api.themoviedb.org/3/search/tv?api_key=${TMDB_API_KEY}&language=es-ES&query=${encodeURIComponent(query)}&page=1`)
    .then(res => res.json())
    .then(data => {
      searchResults.innerHTML = "";
      if (!data.results || data.results.length === 0) {
        searchResults.classList.add("hidden");
        return;
      }
      data.results.slice(0, 7).forEach(serie => {
        const li = document.createElement("li");
        li.textContent = serie.name;
        li.title = serie.name;
        li.addEventListener("click", () => {
          searchResults.classList.add("hidden");
          tmdbSearch.value = serie.name;
          showSeriesDetails(serie.id);
        });
        searchResults.appendChild(li);
      });
      searchResults.classList.remove("hidden");
    })
    .catch(() => {
      searchResults.classList.add("hidden");
      searchResults.innerHTML = "";
    });
});

// Cerrar lista autocompletado si clic fuera
document.addEventListener("click", (e) => {
  if (!tmdbSearch.contains(e.target) && !searchResults.contains(e.target)) {
    searchResults.classList.add("hidden");
  }
});

// Scroll infinito
window.addEventListener("scroll", () => {
  if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200 && !isLoading && currentPage < totalPages) {
    currentPage++;
    let url;
    if (currentMode === "discover") {
      url = `https://api.themoviedb.org/3/discover/tv?api_key=${TMDB_API_KEY}&language=es-ES&sort_by=popularity.desc&page=${currentPage}`;
      if (currentGenre) url += `&with_genres=${currentGenre}`;
      if (currentYear) url += `&first_air_date_year=${currentYear}`;
    } else if (currentMode === "search") {
      url = `https://api.themoviedb.org/3/search/tv?api_key=${TMDB_API_KEY}&language=es-ES&query=${encodeURIComponent(currentQuery)}&page=${currentPage}`;
    }
    if (url) fetchSeries(url, true);
  }
});

// Publicar post en Blogger
async function publishPost() {
  const title = document.getElementById('postTitle').value.trim();
  const content = document.getElementById('postContent').value.trim();
  const labelsRaw = document.getElementById('postLabels').value.trim();
  const labels = labelsRaw ? labelsRaw.split(",").map(l => l.trim()) : [];

  if (!title || !content) {
    status.textContent = "‚ùå El t√≠tulo y contenido son obligatorios.";
    return;
  }

  const post = {
    kind: "blogger#post",
    blog: { id: BLOG_ID },
    title: title,
    content: content,
    labels: labels
  };

  try {
    const response = await gapi.client.request({
      path: `https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts/`,
      method: 'POST',
      body: post
    });
    status.textContent = `‚úÖ Entrada publicada: ${response.result.url}`;
  } catch (error) {
    status.textContent = `‚ùå Error al publicar: ${error.message}`;
  }
}

publishButton.addEventListener("click", publishPost);

// Cargar g√©neros TMDb
function loadGenres() {
  fetch(`https://api.themoviedb.org/3/genre/tv/list?api_key=${TMDB_API_KEY}&language=es-ES`)
    .then(res => res.json())
    .then(data => {
      if (!data.genres) return;
      data.genres.forEach(genre => {
        const option = document.createElement("option");
        option.value = genre.id;
        option.textContent = genre.name;
        genreSelect.appendChild(option);
      });
    })
    .catch(() => {
      const defaultGenres = [
        {id: 10759, name: "Acci√≥n y aventura"},
        {id: 35, name: "Comedia"},
        {id: 18, name: "Drama"},
      ];
      defaultGenres.forEach(genre => {
        const option = document.createElement("option");
        option.value = genre.id;
        option.textContent = genre.name;
        genreSelect.appendChild(option);
      });
    });
}

// Cargar a√±os en filtro
function loadYears() {
  for (let y = 2025; y >= 1950; y--) {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    yearSelect.appendChild(opt);
  }
}

// Inicializar
window.onload = () => {
  loadGenres();
  loadYears();
  if (window.gapi) gapiLoaded();
  if (window.google) gisLoaded();
};

</script>

<script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
